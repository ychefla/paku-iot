# ============================================================================
# Home Assistant – MQTT Sensor Configuration for Paku IoT
# ============================================================================
#
# HOW TO INSTALL:
#   1. Copy this file to your HA config directory: /config/packages/paku.yaml
#   2. Ensure your configuration.yaml has:
#        homeassistant:
#          packages: !include_dir_named packages
#   3. Restart Home Assistant
#
# Or alternatively, paste the contents into your configuration.yaml directly.
#
# MQTT TOPICS REFERENCE:
#   paku/sensors/{device_id}/data     → Consolidated sensor data (Ruuvi, MoKo, DS18B20)
#   paku/edge/{device_id}/status      → Edge device status (retained)
#   paku/heater/{device_id}/state     → Heater state (auto-discovered, no config needed here)
#   paku/heater/{device_id}/cmd       → Heater commands (auto-discovered)
#
# NOTE: The heater (Autoterm Flow 5D) entities are auto-discovered via
# MQTT discovery — they will appear automatically with no config needed.
#
# CUSTOMIZATION:
#   Replace the device_id values below with your actual device IDs.
#   - RuuviTag locations come from secrets.h (e.g., "cabin", "kitchen")
#   - MoKo locations are prefixed: "moko_garage", "moko_outdoor"
#   - DS18B20 device_id is: "{edge_device_id}_wired" (e.g., "ESP32-27C136B8_wired")
#   - Edge device IDs are auto-generated: "ESP32-AABBCCDD"
# ============================================================================

# ──────────────────────────────────────────────────────────────────────────────
# RuuviTag Sensors
# ──────────────────────────────────────────────────────────────────────────────
# Topic: paku/sensors/{ruuvi_location}/data
# Payload: {"timestamp":"...","device_id":"cabin","location":"cabin",
#           "metrics":{"temperature_c":21.5,"humidity_percent":45.2,
#                      "pressure_hpa":1013.25,"battery_mv":2870}}
#
# ⚠ REPLACE "cabin" below with your actual RuuviTag location names from secrets.h
# ⚠ Duplicate each sensor block for every RuuviTag you have
# ──────────────────────────────────────────────────────────────────────────────

mqtt:
  sensor:
    # ── RuuviTag: cabin ────────────────────────────────────────────────────
    - name: "Cabin Temperature"
      state_topic: "paku/sensors/cabin/data"
      value_template: "{{ value_json.metrics.temperature_c | round(1) }}"
      unit_of_measurement: "°C"
      device_class: temperature
      state_class: measurement
      unique_id: paku_ruuvi_cabin_temperature
      device:
        identifiers: ["paku_ruuvi_cabin"]
        name: "RuuviTag Cabin"
        manufacturer: "Ruuvi Innovations"
        model: "RuuviTag"

    - name: "Cabin Humidity"
      state_topic: "paku/sensors/cabin/data"
      value_template: "{{ value_json.metrics.humidity_percent | round(1) }}"
      unit_of_measurement: "%"
      device_class: humidity
      state_class: measurement
      unique_id: paku_ruuvi_cabin_humidity
      device:
        identifiers: ["paku_ruuvi_cabin"]
        name: "RuuviTag Cabin"

    - name: "Cabin Pressure"
      state_topic: "paku/sensors/cabin/data"
      value_template: "{{ value_json.metrics.pressure_hpa | round(1) }}"
      unit_of_measurement: "hPa"
      device_class: atmospheric_pressure
      state_class: measurement
      unique_id: paku_ruuvi_cabin_pressure
      device:
        identifiers: ["paku_ruuvi_cabin"]
        name: "RuuviTag Cabin"

    - name: "Cabin Battery"
      state_topic: "paku/sensors/cabin/data"
      value_template: "{{ value_json.metrics.battery_mv }}"
      unit_of_measurement: "mV"
      device_class: voltage
      state_class: measurement
      unique_id: paku_ruuvi_cabin_battery
      device:
        identifiers: ["paku_ruuvi_cabin"]
        name: "RuuviTag Cabin"

    # ── RuuviTag: kitchen (duplicate & rename for each tag) ────────────────
    # - name: "Kitchen Temperature"
    #   state_topic: "paku/sensors/kitchen/data"
    #   value_template: "{{ value_json.metrics.temperature_c | round(1) }}"
    #   unit_of_measurement: "°C"
    #   device_class: temperature
    #   state_class: measurement
    #   unique_id: paku_ruuvi_kitchen_temperature
    #   device:
    #     identifiers: ["paku_ruuvi_kitchen"]
    #     name: "RuuviTag Kitchen"
    #     manufacturer: "Ruuvi Innovations"
    #     model: "RuuviTag"

    # ──────────────────────────────────────────────────────────────────────────
    # DS18B20 Wired Temperature Sensor
    # ──────────────────────────────────────────────────────────────────────────
    # Topic: paku/sensors/{edge_device_id}_wired/data
    # Payload: {"timestamp":"...","device_id":"ESP32-27C136B8_wired",
    #           "location":"wired_sensor","sensor_type":"DS18B20",
    #           "metrics":{"temperature_c":22.3}}
    #
    # ⚠ REPLACE "ESP32-AABBCCDD" with your actual edge device ID
    # ──────────────────────────────────────────────────────────────────────────
    - name: "Wired Temperature"
      state_topic: "paku/sensors/ESP32-AABBCCDD_wired/data"
      value_template: "{{ value_json.metrics.temperature_c | round(1) }}"
      unit_of_measurement: "°C"
      device_class: temperature
      state_class: measurement
      unique_id: paku_ds18b20_wired_temperature
      device:
        identifiers: ["paku_ds18b20_wired"]
        name: "DS18B20 Wired Sensor"
        manufacturer: "Maxim Integrated"
        model: "DS18B20"

    # ──────────────────────────────────────────────────────────────────────────
    # Edge Device Status
    # ──────────────────────────────────────────────────────────────────────────
    # Topic: paku/edge/{device_id}/status  (retained)
    # Payload: {"online":true,"device_id":"ESP32-27C136B8","mac_address":"...",
    #           "signal_strength_dbm":-65,"uptime_seconds":3600,
    #           "firmware_version":"1.4.2","active_scenario":"heater_active"}
    #
    # ⚠ REPLACE "ESP32-AABBCCDD" with your actual edge device ID
    # ──────────────────────────────────────────────────────────────────────────
    - name: "Edge WiFi Signal"
      state_topic: "paku/edge/ESP32-AABBCCDD/status"
      value_template: "{{ value_json.signal_strength_dbm }}"
      unit_of_measurement: "dBm"
      device_class: signal_strength
      state_class: measurement
      unique_id: paku_edge_signal_strength
      device:
        identifiers: ["paku_edge_ESP32-AABBCCDD"]
        name: "Paku Edge ESP32"
        manufacturer: "LilyGo"
        model: "T-Display S3"
        sw_version: "{{ value_json.firmware_version }}"

    - name: "Edge Uptime"
      state_topic: "paku/edge/ESP32-AABBCCDD/status"
      value_template: "{{ (value_json.uptime_seconds / 3600) | round(1) }}"
      unit_of_measurement: "h"
      device_class: duration
      state_class: measurement
      unique_id: paku_edge_uptime
      device:
        identifiers: ["paku_edge_ESP32-AABBCCDD"]
        name: "Paku Edge ESP32"

    - name: "Edge Firmware"
      state_topic: "paku/edge/ESP32-AABBCCDD/status"
      value_template: "{{ value_json.firmware_version }}"
      unique_id: paku_edge_firmware
      icon: "mdi:chip"
      device:
        identifiers: ["paku_edge_ESP32-AABBCCDD"]
        name: "Paku Edge ESP32"

    - name: "Edge Scenario"
      state_topic: "paku/edge/ESP32-AABBCCDD/status"
      value_template: "{{ value_json.active_scenario }}"
      unique_id: paku_edge_scenario
      icon: "mdi:play-circle-outline"
      device:
        identifiers: ["paku_edge_ESP32-AABBCCDD"]
        name: "Paku Edge ESP32"

  binary_sensor:
    - name: "Edge Online"
      state_topic: "paku/edge/ESP32-AABBCCDD/status"
      value_template: "{{ value_json.online }}"
      payload_on: "True"
      payload_off: "False"
      device_class: connectivity
      unique_id: paku_edge_online
      device:
        identifiers: ["paku_edge_ESP32-AABBCCDD"]
        name: "Paku Edge ESP32"
