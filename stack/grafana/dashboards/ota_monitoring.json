{
  "title": "OTA Update Monitoring",
  "uid": "ota-monitoring",
  "timezone": "browser",
  "schemaVersion": 38,
  "refresh": "5s",
  "time": {
    "from": "now-24h",
    "to": "now"
  },
  "panels": [
    {
      "id": 1,
      "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
      "type": "stat",
      "title": "Total Devices",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT COUNT(*) as total FROM devices",
          "format": "table"
        }
      ],
      "options": {
        "graphMode": "none",
        "colorMode": "value",
        "textMode": "value_and_name"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": {"mode": "palette-classic"}
        }
      }
    },
    {
      "id": 2,
      "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
      "type": "stat",
      "title": "Latest Firmware",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT version FROM firmware_releases ORDER BY created_at DESC LIMIT 1",
          "format": "table"
        }
      ],
      "options": {
        "graphMode": "none",
        "colorMode": "value",
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "string",
          "color": {"mode": "fixed", "fixedColor": "blue"}
        }
      }
    },
    {
      "id": 3,
      "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
      "type": "stat",
      "title": "Devices Up-to-Date",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT COUNT(*) as uptodate FROM devices d WHERE d.current_firmware_version = (SELECT version FROM firmware_releases fr WHERE fr.device_model = d.device_model ORDER BY created_at DESC LIMIT 1)",
          "format": "table"
        }
      ],
      "options": {
        "graphMode": "none",
        "colorMode": "value",
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": {"mode": "thresholds"},
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {"value": 0, "color": "red"},
              {"value": 5, "color": "yellow"},
              {"value": 8, "color": "green"}
            ]
          }
        }
      }
    },
    {
      "id": 4,
      "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
      "type": "stat",
      "title": "Active Updates",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT COUNT(*) as active FROM device_update_status WHERE status = 'in_progress'",
          "format": "table"
        }
      ],
      "options": {
        "graphMode": "none",
        "colorMode": "value",
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": {"mode": "thresholds"},
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {"value": 0, "color": "green"},
              {"value": 1, "color": "blue"}
            ]
          }
        }
      }
    },
    {
      "id": 5,
      "gridPos": {"h": 14, "w": 24, "x": 0, "y": 4},
      "type": "table",
      "title": "Device Status & Update Progress",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "WITH latest_updates AS (
  SELECT DISTINCT ON (device_id)
    device_id,
    firmware_version as target_version,
    status,
    started_at,
    completed_at,
    EXTRACT(EPOCH FROM (COALESCE(completed_at, NOW()) - started_at)) as duration
  FROM device_update_status
  ORDER BY device_id, started_at DESC
),
latest_progress AS (
  SELECT DISTINCT ON (device_id)
    device_id,
    progress_state,
    progress_percent
  FROM device_ota_progress
  WHERE reported_at > NOW() - INTERVAL '5 minutes'
  ORDER BY device_id, reported_at DESC
)
SELECT
  d.device_id as \"Device ID\",
  d.device_model as \"Model\",
  d.current_firmware_version as \"Current Version\",
  CASE
    WHEN lp.progress_percent IS NOT NULL THEN lp.progress_percent || '% ' || lp.progress_state
    ELSE '-'
  END as \"Update Progress\",
  COALESCE(lu.target_version, '-') as \"Target Version\",
  CASE
    WHEN d.online = true THEN 'ðŸŸ¢ Online'
    ELSE 'ðŸ”´ Offline'
  END as \"Online\",
  CASE
    WHEN d.last_seen > NOW() - INTERVAL '5 minutes' THEN TO_CHAR(NOW() - d.last_seen, 'MI\"m\"')
    WHEN d.last_seen > NOW() - INTERVAL '1 hour' THEN TO_CHAR(NOW() - d.last_seen, 'HH24\"h\" MI\"m\"')
    WHEN d.last_seen IS NOT NULL THEN TO_CHAR(d.last_seen, 'YYYY-MM-DD HH24:MI')
    ELSE 'Never'
  END as \"Last Seen\",
  CASE
    WHEN lu.completed_at IS NOT NULL THEN TO_CHAR(lu.completed_at, 'YYYY-MM-DD HH24:MI')
    ELSE 'Never'
  END as \"Last Update\",
  CASE
    WHEN lu.status = 'in_progress' THEN 'ðŸ”„ Updating'
    WHEN lu.status = 'success' THEN 'âœ… Success'
    WHEN lu.status = 'failed' THEN 'âŒ Failed'
    ELSE '-'
  END as \"Status\"
FROM devices d
LEFT JOIN latest_updates lu ON d.device_id = lu.device_id
LEFT JOIN latest_progress lp ON d.device_id = lp.device_id
ORDER BY d.last_seen DESC NULLS LAST",
          "format": "table"
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": []
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "left",
            "cellOptions": {
              "type": "auto"
            }
          }
        },
        "overrides": [
          {
            "matcher": {"id": "byName", "options": "Device ID"},
            "properties": [
              {
                "id": "custom.width",
                "value": 160
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Model"},
            "properties": [
              {
                "id": "custom.width",
                "value": 180
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Current Version"},
            "properties": [
              {
                "id": "custom.width",
                "value": 120
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Update Progress"},
            "properties": [
              {
                "id": "custom.width",
                "value": 180
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Online"},
            "properties": [
              {
                "id": "custom.width",
                "value": 100
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Status"},
            "properties": [
              {
                "id": "custom.width",
                "value": 120
              }
            ]
          }
        ]
      }
    },
    {
      "id": 6,
      "gridPos": {"h": 10, "w": 14, "x": 0, "y": 18},
      "type": "table",
      "title": "Recent Updates (Last 20)",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT
  TO_CHAR(dus.started_at, 'YYYY-MM-DD HH24:MI:SS') as \"Timestamp\",
  dus.device_id as \"Device ID\",
  d.device_model as \"Model\",
  d.current_firmware_version as \"From\",
  dus.firmware_version as \"To\",
  CASE
    WHEN dus.status = 'success' THEN 'âœ… Success'
    WHEN dus.status = 'failed' THEN 'âŒ Failed'
    WHEN dus.status = 'in_progress' THEN 'ðŸ”„ In Progress'
    ELSE dus.status
  END as \"Status\",
  CASE
    WHEN dus.completed_at IS NOT NULL THEN
      ROUND(EXTRACT(EPOCH FROM (dus.completed_at - dus.started_at))::numeric, 0) || 's'
    ELSE '-'
  END as \"Duration\",
  COALESCE(dus.error_message, '-') as \"Message\"
FROM device_update_status dus
LEFT JOIN devices d ON dus.device_id = d.device_id
ORDER BY dus.started_at DESC
LIMIT 20",
          "format": "table"
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": []
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "left"
          }
        },
        "overrides": [
          {
            "matcher": {"id": "byName", "options": "Timestamp"},
            "properties": [
              {
                "id": "custom.width",
                "value": 150
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Device ID"},
            "properties": [
              {
                "id": "custom.width",
                "value": 140
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Status"},
            "properties": [
              {
                "id": "custom.width",
                "value": 120
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Duration"},
            "properties": [
              {
                "id": "custom.width",
                "value": 80
              }
            ]
          }
        ]
      }
    },
    {
      "id": 7,
      "gridPos": {"h": 10, "w": 10, "x": 14, "y": 18},
      "type": "barchart",
      "title": "Update Timeline (Last 30 Days)",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT
  DATE_TRUNC('day', started_at) as time,
  CASE
    WHEN status = 'success' THEN 'Success'
    WHEN status = 'failed' THEN 'Failed'
    WHEN status = 'in_progress' THEN 'In Progress'
    ELSE 'Other'
  END as status,
  COUNT(*) as count
FROM device_update_status
WHERE started_at > NOW() - INTERVAL '30 days'
GROUP BY time, status
ORDER BY time",
          "format": "time_series"
        }
      ],
      "options": {
        "orientation": "auto",
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "xTickLabelRotation": -45,
        "showValue": "auto"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 80,
            "stacking": {
              "mode": "normal"
            }
          },
          "unit": "short",
          "color": {
            "mode": "palette-classic"
          }
        },
        "overrides": [
          {
            "matcher": {"id": "byName", "options": "Success"},
            "properties": [
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "green"
                }
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Failed"},
            "properties": [
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "red"
                }
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "In Progress"},
            "properties": [
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "blue"
                }
              }
            ]
          }
        ]
      }
    }
  ]
}
