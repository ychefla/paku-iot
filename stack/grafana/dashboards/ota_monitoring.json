{
  "title": "OTA Update Monitoring",
  "uid": "ota-monitoring",
  "timezone": "browser",
  "schemaVersion": 38,
  "refresh": "5s",
  "time": {
    "from": "now-24h",
    "to": "now"
  },
  "panels": [
    {
      "id": 1,
      "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
      "type": "stat",
      "title": "Total Devices",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT COUNT(*) as total FROM devices",
          "format": "table"
        }
      ],
      "options": {
        "graphMode": "none",
        "colorMode": "value",
        "textMode": "value_and_name"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": {"mode": "palette-classic"}
        }
      }
    },
    {
      "id": 2,
      "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
      "type": "stat",
      "title": "Latest Firmware",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT version FROM firmware_releases ORDER BY created_at DESC LIMIT 1",
          "format": "table"
        }
      ],
      "options": {
        "graphMode": "none",
        "colorMode": "value",
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "string",
          "color": {"mode": "fixed", "fixedColor": "blue"}
        }
      }
    },
    {
      "id": 3,
      "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
      "type": "stat",
      "title": "Devices Up-to-Date",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT COUNT(*) as uptodate FROM devices d WHERE d.current_firmware_version = (SELECT version FROM firmware_releases fr WHERE fr.device_model = d.device_model ORDER BY created_at DESC LIMIT 1)",
          "format": "table"
        }
      ],
      "options": {
        "graphMode": "none",
        "colorMode": "value",
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": {"mode": "thresholds"},
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {"value": 0, "color": "red"},
              {"value": 5, "color": "yellow"},
              {"value": 8, "color": "green"}
            ]
          }
        }
      }
    },
    {
      "id": 4,
      "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
      "type": "stat",
      "title": "Active Updates",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT COUNT(*) as active FROM device_update_status WHERE status = 'in_progress'",
          "format": "table"
        }
      ],
      "options": {
        "graphMode": "none",
        "colorMode": "value",
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": {"mode": "thresholds"},
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {"value": 0, "color": "green"},
              {"value": 1, "color": "blue"}
            ]
          }
        }
      }
    },
    {
      "id": 5,
      "gridPos": {"h": 14, "w": 24, "x": 0, "y": 4},
      "type": "table",
      "title": "Device Status & Update Progress",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "WITH latest_updates AS (\\n  SELECT DISTINCT ON (device_id)\\n    device_id,\\n    firmware_version as target_version,\\n    status,\\n    started_at,\\n    completed_at,\\n    EXTRACT(EPOCH FROM (COALESCE(completed_at, NOW()) - started_at)) as duration\\n  FROM device_update_status\\n  ORDER BY device_id, started_at DESC\\n),\\nlatest_progress AS (\\n  SELECT DISTINCT ON (device_id)\\n    device_id,\\n    progress_state,\\n    progress_percent\\n  FROM device_ota_progress\\n  WHERE reported_at > NOW() - INTERVAL '5 minutes'\\n  ORDER BY device_id, reported_at DESC\\n)\\nSELECT\\n  d.device_id as \"Device ID\",\\n  d.device_model as \"Model\",\\n  d.current_firmware_version as \"Current Version\",\\n  CASE\\n    WHEN lp.progress_percent IS NOT NULL THEN lp.progress_percent || '% ' || lp.progress_state\\n    ELSE '-'\\n  END as \"Update Progress\",\\n  COALESCE(lu.target_version, '-') as \"Target Version\",\\n  CASE\\n    WHEN d.online = true THEN 'ðŸŸ¢ Online'\\n    ELSE 'ðŸ”´ Offline'\\n  END as \"Online\",\\n  CASE\\n    WHEN d.last_seen > NOW() - INTERVAL '5 minutes' THEN TO_CHAR(NOW() - d.last_seen, 'MI\"m\"')\\n    WHEN d.last_seen > NOW() - INTERVAL '1 hour' THEN TO_CHAR(NOW() - d.last_seen, 'HH24\"h\" MI\"m\"')\\n    WHEN d.last_seen IS NOT NULL THEN TO_CHAR(d.last_seen, 'YYYY-MM-DD HH24:MI')\\n    ELSE 'Never'\\n  END as \"Last Seen\",\\n  CASE\\n    WHEN lu.completed_at IS NOT NULL THEN TO_CHAR(lu.completed_at, 'YYYY-MM-DD HH24:MI')\\n    ELSE 'Never'\\n  END as \"Last Update\",\\n  CASE\\n    WHEN lu.status = 'in_progress' THEN 'ðŸ”„ Updating'\\n    WHEN lu.status = 'success' THEN 'âœ… Success'\\n    WHEN lu.status = 'failed' THEN 'âŒ Failed'\\n    ELSE '-'\\n  END as \"Status\"\\nFROM devices d\\nLEFT JOIN latest_updates lu ON d.device_id = lu.device_id\\nLEFT JOIN latest_progress lp ON d.device_id = lp.device_id\\nORDER BY d.last_seen DESC NULLS LAST",
          "format": "table"
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": []
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "left",
            "cellOptions": {
              "type": "auto"
            }
          }
        },
        "overrides": [
          {
            "matcher": {"id": "byName", "options": "Device ID"},
            "properties": [
              {
                "id": "custom.width",
                "value": 160
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Model"},
            "properties": [
              {
                "id": "custom.width",
                "value": 180
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Current Version"},
            "properties": [
              {
                "id": "custom.width",
                "value": 120
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Update Progress"},
            "properties": [
              {
                "id": "custom.width",
                "value": 180
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Online"},
            "properties": [
              {
                "id": "custom.width",
                "value": 100
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Status"},
            "properties": [
              {
                "id": "custom.width",
                "value": 120
              }
            ]
          }
        ]
      }
    },
    {
      "id": 6,
      "gridPos": {"h": 10, "w": 14, "x": 0, "y": 18},
      "type": "table",
      "title": "Recent Updates (Last 20)",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT\\n  TO_CHAR(dus.started_at, 'YYYY-MM-DD HH24:MI:SS') as \"Timestamp\",\\n  dus.device_id as \"Device ID\",\\n  d.device_model as \"Model\",\\n  d.current_firmware_version as \"From\",\\n  dus.firmware_version as \"To\",\\n  CASE\\n    WHEN dus.status = 'success' THEN 'âœ… Success'\\n    WHEN dus.status = 'failed' THEN 'âŒ Failed'\\n    WHEN dus.status = 'in_progress' THEN 'ðŸ”„ In Progress'\\n    ELSE dus.status\\n  END as \"Status\",\\n  CASE\\n    WHEN dus.completed_at IS NOT NULL THEN\\n      ROUND(EXTRACT(EPOCH FROM (dus.completed_at - dus.started_at))::numeric, 0) || 's'\\n    ELSE '-'\\n  END as \"Duration\",\\n  COALESCE(dus.error_message, '-') as \"Message\"\\nFROM device_update_status dus\\nLEFT JOIN devices d ON dus.device_id = d.device_id\\nORDER BY dus.started_at DESC\\nLIMIT 20",
          "format": "table"
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": []
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "left"
          }
        },
        "overrides": [
          {
            "matcher": {"id": "byName", "options": "Timestamp"},
            "properties": [
              {
                "id": "custom.width",
                "value": 150
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Device ID"},
            "properties": [
              {
                "id": "custom.width",
                "value": 140
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Status"},
            "properties": [
              {
                "id": "custom.width",
                "value": 120
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Duration"},
            "properties": [
              {
                "id": "custom.width",
                "value": 80
              }
            ]
          }
        ]
      }
    },
    {
      "id": 7,
      "gridPos": {"h": 10, "w": 10, "x": 14, "y": 18},
      "type": "barchart",
      "title": "Update Timeline (Last 30 Days)",
      "datasource": {
        "type": "postgres",
        "uid": "DS_POSTGRESQL"
      },
      "targets": [
        {
          "refId": "A",
          "rawSql": "SELECT\\n  DATE_TRUNC('day', started_at) as time,\\n  CASE\\n    WHEN status = 'success' THEN 'Success'\\n    WHEN status = 'failed' THEN 'Failed'\\n    WHEN status = 'in_progress' THEN 'In Progress'\\n    ELSE 'Other'\\n  END as status,\\n  COUNT(*) as count\\nFROM device_update_status\\nWHERE started_at > NOW() - INTERVAL '30 days'\\nGROUP BY time, status\\nORDER BY time",
          "format": "time_series"
        }
      ],
      "options": {
        "orientation": "auto",
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "xTickLabelRotation": -45,
        "showValue": "auto"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 80,
            "stacking": {
              "mode": "normal"
            }
          },
          "unit": "short",
          "color": {
            "mode": "palette-classic"
          }
        },
        "overrides": [
          {
            "matcher": {"id": "byName", "options": "Success"},
            "properties": [
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "green"
                }
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "Failed"},
            "properties": [
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "red"
                }
              }
            ]
          },
          {
            "matcher": {"id": "byName", "options": "In Progress"},
            "properties": [
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "blue"
                }
              }
            ]
          }
        ]
      }
    }
  ]
}
