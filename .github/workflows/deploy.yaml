name: Deploy to Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/paku/paku-iot

jobs:
  deploy:
    name: Deploy to Hetzner VM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.HETZNER_HOST }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          GF_SECURITY_ADMIN_PASSWORD: ${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}
        run: |
          # Create deployment script
          cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          DEPLOY_PATH="${DEPLOY_PATH}"
          
          echo "=== Deploying paku-iot ==="
          
          # Clone or update repository
          if [ -d "$DEPLOY_PATH" ]; then
            echo "Updating existing deployment..."
            cd "$DEPLOY_PATH"
            git fetch origin main
            git reset --hard origin/main
          else
            echo "Creating new deployment..."
            git clone https://github.com/ychefla/paku-iot.git "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"
          fi
          
          # Create .env file with production secrets
          cat > compose/.env << EOF
          # Production environment - auto-generated by GitHub Actions
          POSTGRES_USER=paku
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=paku
          
          MQTT_HOST=mosquitto
          MQTT_PORT=1883
          
          GF_SECURITY_ADMIN_USER=admin
          GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
          EOF
          
          chmod 600 compose/.env
          
          # Build and deploy
          echo "Building and starting services..."
          docker compose -f compose/stack.prod.yaml pull 2>/dev/null || true
          docker compose -f compose/stack.prod.yaml build
          docker compose -f compose/stack.prod.yaml up -d
          
          # Wait for services to be healthy
          echo "Waiting for services to be healthy..."
          sleep 10
          
          # Check service status
          echo "=== Service Status ==="
          docker compose -f compose/stack.prod.yaml ps
          
          # Clean up old images
          docker image prune -f
          
          echo "=== Deployment complete ==="
          DEPLOY_SCRIPT
          
          # Copy and execute deployment script
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new /tmp/deploy.sh paku@${SSH_HOST}:/tmp/deploy.sh
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new paku@${SSH_HOST} "
            export DEPLOY_PATH='${DEPLOY_PATH}'
            export POSTGRES_PASSWORD='${POSTGRES_PASSWORD}'
            export GF_SECURITY_ADMIN_PASSWORD='${GF_SECURITY_ADMIN_PASSWORD}'
            chmod +x /tmp/deploy.sh
            /tmp/deploy.sh
            rm /tmp/deploy.sh
          "

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new paku@${{ secrets.HETZNER_HOST }} "
            cd ${DEPLOY_PATH}
            echo '=== Container Health Check ==='
            docker compose -f compose/stack.prod.yaml ps --format 'table {{.Name}}\t{{.Status}}\t{{.Ports}}'
            
            echo ''
            echo '=== Recent Logs ==='
            docker compose -f compose/stack.prod.yaml logs --tail=5
          "

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
