name: OTA Update ESP Devices

on:
  workflow_dispatch:
    inputs:
      rollout_strategy:
        description: 'Rollout strategy'
        required: true
        type: choice
        options:
          - single-device
          - canary-10
          - canary-25
          - canary-50
          - full
        default: 'single-device'
      device_model:
        description: 'Device model'
        required: true
        type: choice
        options:
          - lilygo-t-display-s3
          - esp32-ch340c-30pin
          - esp8266-wired-sensors
        default: 'lilygo-t-display-s3'
      test_devices:
        description: 'Device IDs (comma-separated, only for single-device strategy)'
        required: false
        type: string
        default: ''
      additional_ssid:
        description: 'Additional WiFi SSID (optional, for site-specific deployment)'
        required: false
        type: string
        default: ''
      additional_password:
        description: 'Additional WiFi password (optional)'
        required: false
        type: string
        default: ''
      release_notes:
        description: 'Release notes'
        required: false
        type: string
        default: 'Automated OTA update from paku-core main branch'

permissions:
  contents: read

jobs:
  build-and-deploy-ota:
    name: Build and Deploy OTA Update
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout paku-core repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PAKU_CORE_REPO || 'ychefla/paku-core' }}
          ref: main
          token: ${{ secrets.PAKU_CORE_TOKEN || github.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
            paku_core/.pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Install PlatformIO
        run: |
          pip install --upgrade platformio
          pio --version

      - name: Copy secrets template
        shell: bash
        env:
          WIFI_SSIDS_SECRET: ${{ secrets.WIFI_SSIDS }}
          WIFI_PASSWORDS_SECRET: ${{ secrets.WIFI_PASSWORDS }}
          MQTT_SERVER_SECRET: ${{ secrets.MQTT_SERVER }}
          ADDITIONAL_SSID: ${{ github.event.inputs.additional_ssid }}
          ADDITIONAL_PASSWORD: ${{ github.event.inputs.additional_password }}
        run: |
          cd paku_core
          # Use template or inject secrets from GitHub Secrets (if provided)
          if [ -n "$WIFI_SSIDS_SECRET" ]; then
            echo "Using WiFi credentials from GitHub Secrets"
            
            # Write secrets to temp files using environment variables (avoids bash parsing)
            printf '%s' "$WIFI_SSIDS_SECRET" > /tmp/ssids.json
            printf '%s' "$WIFI_PASSWORDS_SECRET" > /tmp/passwords.json
            
            # Add additional SSID if provided
            if [ -n "$ADDITIONAL_SSID" ]; then
              echo "Adding additional WiFi network: $ADDITIONAL_SSID"
              
              # Append additional network to arrays
              TEMP_SSIDS=$(jq --arg ssid "$ADDITIONAL_SSID" '. + [$ssid]' /tmp/ssids.json)
              TEMP_PASSWORDS=$(jq --arg pwd "$ADDITIONAL_PASSWORD" '. + [$pwd]' /tmp/passwords.json)
              
              printf '%s' "$TEMP_SSIDS" > /tmp/ssids.json
              printf '%s' "$TEMP_PASSWORDS" > /tmp/passwords.json
            fi
            
            # Convert JSON arrays to C arrays
            SSID_ARRAY=$(jq -r '.[] | @json' /tmp/ssids.json | paste -sd ',' -)
            PASSWORD_ARRAY=$(jq -r '.[] | @json' /tmp/passwords.json | paste -sd ',' -)
            WIFI_COUNT=$(jq '. | length' /tmp/ssids.json)
            
            # Clean up temp files
            rm -f /tmp/ssids.json /tmp/passwords.json
            
            cat > include/secrets.h << EOF
          #pragma once
          
          // Auto-generated from GitHub Secrets for OTA build
          #define LOG_ENABLED 1
          #define LOG_INFO_ENABLED 1
          
          static const char* WIFI_SSIDS[] = { $SSID_ARRAY };
          static const char* WIFI_PASSWORDS[] = { $PASSWORD_ARRAY };
          static const size_t WIFI_COUNT = $WIFI_COUNT;
          
          #define MQTT_SERVER "$MQTT_SERVER_SECRET"
          #define MQTT_PORT 1883
          
          #define PAKU_IOT_ENABLED 0
          #define PAKU_IOT_HOST "localhost"
          #define PAKU_IOT_PORT 443
          #define PAKU_IOT_API_KEY "not-used"
          #define PAKU_IOT_USE_TLS false
          EOF
          else
            echo "Using secrets template (no GitHub Secrets configured)"
            cp include/secrets.h.template include/secrets.h
          fi
          
          # Create device_config.h with the appropriate device based on build environment
          if [[ "${{ github.event.inputs.device_model }}" == *"lilygo"* ]] || [[ "${{ github.event.inputs.device_model }}" == "esp32-s3" ]]; then
            sed 's|// #define DEVICE_LILYGO_T_DISPLAY_S3|#define DEVICE_LILYGO_T_DISPLAY_S3|' src/device_config.h.template > src/device_config.h
            sed -i 's|^#define DEVICE_ESP8266_WIRED_SENSORS|// #define DEVICE_ESP8266_WIRED_SENSORS|' src/device_config.h
          elif [[ "${{ github.event.inputs.device_model }}" == "esp8266"* ]]; then
            cp src/device_config.h.template src/device_config.h
          else
            # Generic ESP32
            sed 's|// #define DEVICE_ESP32_CH340C_30PIN|#define DEVICE_ESP32_CH340C_30PIN|' src/device_config.h.template > src/device_config.h
            sed -i 's|^#define DEVICE_ESP8266_WIRED_SENSORS|// #define DEVICE_ESP8266_WIRED_SENSORS|' src/device_config.h
          fi

      - name: Build firmware
        run: |
          cd paku_core
          echo "Building firmware for ${{ github.event.inputs.device_model }}..."
          pio run --environment ${{ github.event.inputs.device_model }}
          
          # Find the built firmware (specifically firmware.bin, not partitions.bin)
          FIRMWARE_PATH=".pio/build/${{ github.event.inputs.device_model }}/firmware.bin"
          
          if [ ! -f "$FIRMWARE_PATH" ]; then
            echo "Error: Firmware binary not found at $FIRMWARE_PATH"
            ls -la ".pio/build/${{ github.event.inputs.device_model }}/" || true
            exit 1
          fi
          
          echo "Firmware built successfully: $FIRMWARE_PATH"
          echo "Firmware size: $(stat -c%s "$FIRMWARE_PATH" 2>/dev/null || stat -f%z "$FIRMWARE_PATH") bytes"
          
          # Store path relative to repo root
          echo "FIRMWARE_PATH=paku_core/$FIRMWARE_PATH" >> $GITHUB_ENV
          
          # Calculate checksum
          FIRMWARE_SHA256=$(sha256sum "$FIRMWARE_PATH" | cut -d' ' -f1)
          echo "FIRMWARE_SHA256=$FIRMWARE_SHA256" >> $GITHUB_ENV
          echo "Firmware SHA256: $FIRMWARE_SHA256"

      - name: Generate version from commit
        run: |
          # Use short commit hash and timestamp for version
          VERSION="${GITHUB_SHA:0:7}-$(date +%Y%m%d-%H%M%S)"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Generated version: $VERSION"

      - name: Upload firmware to OTA service
        run: |
          echo "Uploading firmware to OTA service..."
          echo "Firmware path: ${FIRMWARE_PATH}"
          echo "Firmware size: $(stat -c%s "${FIRMWARE_PATH}" 2>/dev/null || stat -f%z "${FIRMWARE_PATH}")"
          
          # Install requests library if needed
          pip3 install --quiet requests 2>/dev/null || true
          
          # Use Python requests instead of curl for more reliable multipart upload
          python3 <<'PYEOF'
          import os
          import sys
          
          try:
              import requests
          except ImportError:
              print("Error: requests library not available")
              sys.exit(1)
          
          firmware_path = os.environ['FIRMWARE_PATH']
          version = os.environ['VERSION']
          device_model = "${{ github.event.inputs.device_model }}"
          ota_url = "${{ secrets.OTA_SERVICE_URL || 'http://localhost:8080' }}"
          api_key = "${{ secrets.OTA_API_KEY }}"
          release_notes = "${{ github.event.inputs.release_notes }}"
          
          # Build URL with query parameters
          url = f"{ota_url}/api/admin/firmware/upload"
          params = {
              "version": version,
              "device_model": device_model,
              "is_signed": "false"
          }
          
          if release_notes:
              params["release_notes"] = release_notes
          
          print(f"Uploading to: {url}")
          print(f"Parameters: {params}")
          
          try:
              # Upload file
              headers = {"X-API-Key": api_key}
              with open(firmware_path, 'rb') as f:
                  files = {'file': (os.path.basename(firmware_path), f, 'application/octet-stream')}
                  response = requests.post(url, params=params, headers=headers, files=files, timeout=60)
              
              print(f"Response status: {response.status_code}")
              print(f"Response body: {response.text}")
              
              if response.status_code != 200:
                  print(f"Error: Failed to upload firmware (HTTP {response.status_code})")
                  sys.exit(1)
              
              print("Firmware uploaded successfully!")
              
          except Exception as e:
              print(f"Error uploading firmware: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYEOF

      - name: Create rollout configuration
        run: |
          echo "Creating rollout configuration for strategy: ${{ github.event.inputs.rollout_strategy }}..."
          
          STRATEGY="${{ github.event.inputs.rollout_strategy }}"
          ROLLOUT_NAME="${{ github.event.inputs.device_model }}-${VERSION}-${STRATEGY}"
          
          # Prepare rollout payload based on strategy
          case "$STRATEGY" in
            test)
              if [ -z "${{ github.event.inputs.test_devices }}" ]; then
                echo "Error: test_devices must be provided for test strategy"
                exit 1
              fi
              # Convert comma-separated list to JSON array
              DEVICE_ARRAY=$(echo '${{ github.event.inputs.test_devices }}' | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";""))')
              PAYLOAD=$(jq -n \
                --arg name "$ROLLOUT_NAME" \
                --arg version "$VERSION" \
                --arg model "${{ github.event.inputs.device_model }}" \
                --argjson devices "$DEVICE_ARRAY" \
                '{
                  name: $name,
                  firmware_version: $version,
                  device_model: $model,
                  target_type: "specific",
                  target_device_ids: $devices,
                  is_active: true
                }')
              ;;
            canary-10|canary-25|canary-50)
              PERCENTAGE=$(echo "$STRATEGY" | cut -d- -f2)
              PAYLOAD=$(jq -n \
                --arg name "$ROLLOUT_NAME" \
                --arg version "$VERSION" \
                --arg model "${{ github.event.inputs.device_model }}" \
                --argjson pct "$PERCENTAGE" \
                '{
                  name: $name,
                  firmware_version: $version,
                  device_model: $model,
                  target_type: "canary",
                  rollout_percentage: $pct,
                  is_active: true
                }')
              ;;
            full)
              PAYLOAD=$(jq -n \
                --arg name "$ROLLOUT_NAME" \
                --arg version "$VERSION" \
                --arg model "${{ github.event.inputs.device_model }}" \
                '{
                  name: $name,
                  firmware_version: $version,
                  device_model: $model,
                  target_type: "all",
                  is_active: true
                }')
              ;;
            *)
              echo "Error: Unknown rollout strategy: $STRATEGY"
              exit 1
              ;;
          esac
          
          echo "Rollout payload:"
          echo "$PAYLOAD" | jq '.'
          
          # Create rollout
          ROLLOUT_RESPONSE=$(curl -v -X POST \
            "${{ secrets.OTA_SERVICE_URL || 'http://localhost:8080' }}/api/admin/rollout/create" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.OTA_API_KEY }}" \
            -d "$PAYLOAD" \
            -w "\nHTTP_CODE:%{http_code}" \
            2>&1)
          
          HTTP_CODE=$(echo "$ROLLOUT_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Failed to create rollout (HTTP $HTTP_CODE)"
            echo "$ROLLOUT_RESPONSE"
            exit 1
          fi
          
          echo "Rollout created successfully!"
          echo "$ROLLOUT_RESPONSE" | grep -v "HTTP_CODE:" | jq '.'

      - name: Generate deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ESP OTA Deployment Summary
          
          ## Firmware Details
          - **Version**: \`${VERSION}\`
          - **Device Model**: \`${{ github.event.inputs.device_model }}\`
          - **Commit**: \`${GITHUB_SHA:0:7}\`
          - **SHA256**: \`${FIRMWARE_SHA256}\`
          
          ## Rollout Configuration
          - **Strategy**: \`${{ github.event.inputs.rollout_strategy }}\`
          - **Rollout Name**: \`${{ github.event.inputs.device_model }}-${VERSION}-${{ github.event.inputs.rollout_strategy }}\`
          EOF
          
          if [ "${{ github.event.inputs.rollout_strategy }}" = "single-device" ]; then
            echo "- **Target Devices**: \`${{ github.event.inputs.test_devices }}\`" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event.inputs.rollout_strategy }}" == canary-* ]]; then
            PERCENTAGE=$(echo "${{ github.event.inputs.rollout_strategy }}" | cut -d- -f2)
            echo "- **Rollout Percentage**: ${PERCENTAGE}%" >> $GITHUB_STEP_SUMMARY
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ## Release Notes
          ${{ github.event.inputs.release_notes }}
          
          ## Monitoring
          - Check OTA service metrics: ${{ secrets.OTA_SERVICE_URL || 'http://localhost:8080' }}/metrics
          - View Grafana dashboard for real-time update status
          
          ## Next Steps
          1. Monitor device update progress in Grafana
          2. Check for any failed updates
          3. If using canary rollout, gradually increase percentage after validation
          4. For issues, deactivate rollout via admin API
          EOF

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::OTA deployment failed! Check logs for details."
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âŒ ESP OTA Deployment Failed
          
          The OTA deployment encountered an error. Please check the workflow logs for details.
          
          ## Troubleshooting
          - Verify OTA service is accessible at: ${{ secrets.OTA_SERVICE_URL || 'http://localhost:8080' }}
          - Check OTA_API_KEY is configured correctly in secrets
          - Ensure paku-core repository builds successfully
          - Review firmware build logs above
          EOF
